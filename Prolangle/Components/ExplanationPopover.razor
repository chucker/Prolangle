@using Microsoft.JSInterop
@using System.Text.Json

@implements IAsyncDisposable

@inject IJSRuntime JS

@if (WillHavePopover)
{
    <div @ref="titleElement" style="display: none">
        <p>@Title</p>
        <p><a href="@Url"><strong>More</strong> Information</a></p>
    </div>

    <span @ref="popoverElement">
        @ChildContent
    </span>
}
else
{
    @ChildContent
}

@code {
    private IJSObjectReference? jsModule;
    private ElementReference popoverElement;
    private ElementReference titleElement;

    bool WillHavePopover => !string.IsNullOrWhiteSpace(Content);

    [Parameter] public RenderFragment ChildContent { get; set; }

    [Parameter] public string Content { get; set; }
    [Parameter] public string Title { get; set; }
    [Parameter] public string Url { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && WillHavePopover)
        {
            jsModule = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Components/ExplanationPopover.razor.js");

            await jsModule.InvokeVoidAsync("ExplanationPopover.init",
                popoverElement, titleElement, GetSerializedOptions());
        }
    }

    private string GetSerializedOptions()
    {
        return JsonSerializer.Serialize(new
        {
            content = Content,
            trigger = "click",
        });
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule is null || !WillHavePopover)
            return;

        await jsModule.InvokeVoidAsync("ExplanationPopover.destroy", popoverElement);

        await jsModule.DisposeAsync();
    }

}
